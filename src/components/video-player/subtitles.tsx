const ass = `
[Script Info]
Title: [Erai-raws] English (US)
ScriptType: v4.00+
WrapStyle: 0
PlayResX: 1280
PlayResY: 720
ScaledBorderAndShadow: yes

[V4+ Styles]
Format: Name, Fontname, Fontsize, PrimaryColour, SecondaryColour, OutlineColour, BackColour, Bold, Italic, Underline, StrikeOut, ScaleX, ScaleY, Spacing, Angle, BorderStyle, Outline, Shadow, Alignment, MarginL, MarginR, MarginV, Encoding
Style: Default,Arial,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Song,Swis721 BT,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Subtitle,Swis721 BT,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption,BakerSignet BT,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-2,BakerSignet BT,40,&H008E48F7,&H008E48F7,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-3,Mead Bold,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-4,Tahoma,33,&H00C6DEEA,&H00C6DEEA,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Subtitle-2,Swis721 BT,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Subtitle-3,Swis721 BT,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-5,BakerSignet BT,40,&H00FF00FF,&H00FF00FF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-6,BakerSignet BT,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-7,Mead Bold,48,&H000000FF,&H000000FF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-8,Calibri Light,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-9,Calibri Light,33,&H00F2C882,&H00F2C882,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-10,Mead Bold,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-11,Balloon Bd BT,40,&H00FFF1BF,&H00FFF1BF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-12,Calibri Light,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-13,Calibri,48,&H008F8F8F,&H008F8F8F,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-14,Calibri,48,&H00919191,&H00919191,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-15,Calibri,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-16,Calibri,33,&H00F2C882,&H00F2C882,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-17,Calibri,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-18,Calibri,40,&H00F2C882,&H00F2C882,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-19,Calibri,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-20,Tahoma,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Subtitle-4,Swis721 BT,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-21,Calibri Light,33,&H008E48F7,&H008E48F7,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-22,Calibri,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-23,Calibri,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-24,Calibri,40,&H00F2C882,&H00F2C882,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-25,Calibri,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-26,Calibri,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-27,Calibri,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-28,Calibri,25,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-29,Calibri Light,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-30,Calibri,40,&H003A8242,&H003A8242,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-31,Calibri,40,&H002F12DC,&H002F12DC,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-32,Calibri,48,&H00FA6C61,&H00FA6C61,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-33,Calibri,48,&H003A8242,&H003A8242,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-34,Calibri,48,&H002F12DC,&H002F12DC,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-35,Calibri,40,&H003A8242,&H003A8242,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-36,Calibri Light,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-37,Calibri Light,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-38,FinkSans,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-39,FinkSans,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-40,Calibri Light,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-41,Calibri Light,40,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-42,Calibri Light,33,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-43,Calibri Light,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-44,Incised901 Bd BT,48,&H000900F1,&H000900F1,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-45,Incised901 Bd BT,48,&H00F700A2,&H00F700A2,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-46,Incised901 Bd BT,48,&H004F00A8,&H004F00A8,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-47,VAGRounded BT,48,&H0028136E,&H0028136E,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1
Style: Caption-48,VAGRounded BT,48,&H00FFFFFF,&H00FFFFFF,&H00000000,&H00000000,-1,0,0,0,100,100,0,0,1,1,2,2,20,20,20,1

[Events]
Format: Layer, Start, End, Style, Name, MarginL, MarginR, MarginV, Effect, Text

Dialogue: 0,0:00:00.51,0:20:20.43,Caption-15,,0,0,0,,{\\pos(281.6,223.2)}{\\an7}King
Dialogue: 0,0:00:00.51,0:20:20.43,Caption-15,,0,0,0,,{\\pos(243.2,288)}{\\an7}Ah, I almost forgot that girl's on the show.
Dialogue: 0,0:00:00.51,0:20:20.43,Caption-15,,0,0,0,,{\\pos(256,352.8)}{\\an7}Her name's Akane, right?
Dialogue: 0,0:00:00.51,0:20:20.43,Subtitle,,0,0,0,,Ah, I almost forgot that girl's on the show.\\NHer name's Akane, right?
`;

import { ParsedASSEvent, compile, decompile, parse } from 'ass-compiler';
import clsx from 'clsx';
import { useEffect } from 'react';
import {
  SubtitleBackground,
  SubtitleColor,
  SubtitleSize,
  useVideoPlayerStore,
} from './video-player-store';
import { BRACES_CONTENT_REGEX } from '@common/constants/regex';
import HTMLReactParser from 'html-react-parser';

const compiledASS = compile(ass, {});
const decompiledText = decompile(compiledASS);
const parsedASS = parse(decompiledText);

console.log('ðŸš€ ~ file: subtitles.tsx:91 ~ parsedASS:', parsedASS);

const parseSubtitleText = (subtitle: string) => {
  const subtitleWithoutComments = subtitle.replaceAll(BRACES_CONTENT_REGEX, '');
  const subtitleWithNewLines = subtitleWithoutComments
    .replaceAll('\n', '<br>')
    .replaceAll('\\N', '<br>');

  const parsedSubtitle = HTMLReactParser(subtitleWithNewLines);
  return parsedSubtitle;
};

const buildSubtitleTextClass = (color: SubtitleColor, size: SubtitleSize) => {
  const colorClass = buildSubtitlesColor(color);
  const sizeClass = buildSubtitlesSize(size);

  return `${colorClass} ${sizeClass}`;
};

const buildSubtitlesColor = (color: SubtitleColor) => {
  switch (color) {
    case 'white':
      return 'text-white-300';
    case 'yellow':
      return 'text-amber-300';
  }
};

const buildSubtitlesSize = (size: SubtitleSize) => {
  switch (size) {
    case 'small':
      return 'text-2xl';
    case 'medium':
      return 'text-4xl';
    case 'large':
      return 'text-6xl';
  }
};

const buildSubtitlesBackgroundColor = (background: SubtitleBackground) => {
  switch (background) {
    case 'black':
      return 'bg-[rgba(1,1,1,0.6)] ';
    case 'transparent':
      return 'bg-transparent';
  }
};

export const SubtitlesV2 = () => {
  const {
    currentTime,
    subtitleConfig,
    shouldShowControls: isShowingControls,
  } = useVideoPlayerStore();
  const { color, background, size } = subtitleConfig;

  const textClassName = buildSubtitleTextClass(color, size);
  const backgroundClassName = buildSubtitlesBackgroundColor(background);

  const visibleDialogs = parsedASS.events.dialogue.filter((subtitle) => {
    return currentTime >= subtitle.Start && currentTime <= subtitle.End;
  });

  const floatingCaptions = visibleDialogs.filter((sub) =>
    sub.Text.parsed.some((s) => s.tags.some((t) => t.pos))
  );

  const subtitles = visibleDialogs.filter((sub) =>
    sub.Text.parsed.some((s) => !s.tags.some((t) => t.pos))
  );

  const px = parseInt(parsedASS.info.PlayResX);
  const py = parseInt(parsedASS.info.PlayResY);

  useEffect(() => {
    console.log(currentTime);
  }, [currentTime]);

  return (
    <div
      className={clsx(
        'absolute flex w-full select-none items-center gap-2 h-full flex-col-reverse bottom-0'
      )}
      id="sub"
    >
      {floatingCaptions.map((sub) =>
        sub.Text.parsed.map((text) => {
          const pos = text.tags.find((tag) => tag.pos);
          return (
            <div
              className={clsx(
                `${textClassName} text-center font-subtitle font-bold antialiased ${backgroundClassName}`
              )}
              style={
                pos
                  ? {
                      position: 'absolute',
                      left: `${(100 * pos.pos![0]) / px}%`,
                      top: `${(100 * pos.pos![1]) / py}%`,
                      textShadow:
                        background === 'transparent'
                          ? '#000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px'
                          : '',
                    }
                  : {}
              }
              key={text.text}
            >
              {text.text.split('\\N').map((line) => (
                <div key={line}>{line}</div>
              ))}
            </div>
          );
        })
      )}
      <div
        className={clsx(
          `${textClassName} absolute text-center font-subtitle font-bold antialiased ${backgroundClassName}`,
          isShowingControls ? 'bottom-16' : 'bottom-4'
        )}
        style={{
          textShadow:
            background === 'transparent'
              ? '#000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px, #000 0px 0px 3px'
              : '',
        }}
      >
        {subtitles.map((sub) =>
          sub.Text.parsed.map((text) => {
            return (
              <div key={text.text}>
                {text.text.split('\\N').map((line) => (
                  <div key={line}>{line}</div>
                ))}
              </div>
            );
          })
        )}
      </div>
    </div>
  );
};
